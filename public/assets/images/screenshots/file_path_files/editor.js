function TextEditor(n,t){var b=this,i=$(n),ft=!1,r=!1,y=!1,et="",o="",a=!1,e=null,u="",ht;t=t||defaultEditorConfig;var p=!1,k="",h,c,s,l,d,g,nt,tt,it,dt=function(n){if(!n)return null;if(!$.support.opacity)return n;var t=$("<div/>").html(n).text().trim();return t=t.replace(/\</gi,"&lt;"),t.replace(/\r\n\r\n\r\n\r\n/,"\r\n\r\n")},w=function(){var n=navigator.userAgent.toLowerCase();return n.indexOf("msie")!=-1?parseInt(n.split("msie")[1]):!1},rt=function(n){var t=new RegExp("^((ht|f)tps?://|www.)([^ \n\t]*)$","i");return n&&t.test(n)},ut=function(){var n=$("#"+t.IgnoreHtmlId);return n.length>0&&n[0].checked},ct=function(){var n=$("#"+t.AllowMarkdownId);return n.length>0&&n[0].checked},ot=function(n){return n.replace(/\r\n\r\n/gm,"\r\n")},gt=function(n){return n.replace(/\r\n/g,"\n").replace(/\n/g,"<br>")},ni=function(n){var t=new RegExp("<(/?)(html|body|base|basefont|head|meta|xmp|script|noscript|isindex|src|bdo|xml|plaintext|object|applet|embed|bgsound|marquee|title|form|input|button|select|option|textarea|optgroup|label|frame|frameset|iframe|noframes)","gi");return n.replace(t,"&lt;$1$2")},lt=function(n){return n.replace(/(<([^>]+)>)/ig,"")},at=function(){var r=!ut(),n=null,u,t,f,i,e;if(typeof document.selection!="undefined"&&document.selection.createRange)document.selection.type=="Text"&&(u=document.selection.createRange(),n=r?u.htmlText:u.text);else if(typeof getSelection!="undefined")if(t=window.getSelection(),r&&t.rangeCount){for(f=document.createElement("div"),i=0,e=t.rangeCount;i<e;++i)f.appendChild(t.getRangeAt(i).cloneContents());n=f.innerHTML}else n=window.getSelection().toString();return n&&(r&&(n=n.replace(/<br[^>]*?>/igm,"")),n=n.replace(/<img[^>]*alt=[^\|]*\|\s([^"]*)[^>]*>/igm,"$1")),n},ti=function(n,t){if(r||n.length<=0)return!1;var f="<"+n+(t?" "+t:t)+">",e="<\/"+n+">",u=i.getSelectedText(!0);return u=u.substr(0,f.length)==f&&u.substr(u.length-e.length)==e?u.substr(f.length,u.length-f.length-e.length):f+u+e,i.replaceSelectedText(u),!1},vt=function(n,r,u){var f={},e,c,o,h,s;if(f.offset=0,f.html=n?n:r,f.titleLength=f.html.length,n.length>2048)return f;if(r||(r=n),r=$.trim(r),e=r.toLowerCase(),rt(e))if(i.isCursorInsideOpenTag()||i.isCursorInsideTag("a"))f.html=r,f.titleLength=r.length;else{if(e.substr(0,5)!="http:"&&e.substr(0,4)!="ftp:"&&e.substr(0,6)!="https:"&&(r="http://"+r),!n)for(c=0;c<t.GetTitlePaths.length;c++)if(o=t.GetTitlePaths[c],o.path==null||e.substr(0,o.path.length)==o.path){h=$.ajax({type:"GET",timeout:2e3,url:o.url,data:o.param+"="+r,async:!1}).responseText;h&&h.length>0&&h.length<500&&(n=h.htmlEncode());break}ct()?(s="[",f.offset=s.length,f.titleLength=n.length,f.html=s+n+"]("+r+")"):(s='<a href="'+r+'">',f.offset=s.length,f.titleLength=n.length,f.html=s+n+"<\/a>",u&&(f.html+='[<a href="'+r+'" target="_blank" title="New Window">^<\/a>]'))}return f},yt=function(n,t){switch(t){case"Sentence":return n.toSentenceCase();case"Title":return n.toTitleCase();case"Lowercase":return n.toLowerCase();case"Uppercase":return n.toUpperCase()}},v=function(n){while(n.indexOf("\r\n")>=0)n=n.replace(/\r\n/g,String.fromCharCode(1));var i=document.createElement("div"),t=document.createTextNode(n);for(i.appendChild(t),t=i.innerHTML;t.indexOf(String.fromCharCode(1))>=0;)t=t.replace(String.fromCharCode(1),"\r\n");return t},pt=function(){if(!i)return!0;if(i.val(i.val().trim()),t.LongMsgWarning)if(i.val().length>1e4){if(!confirm("This message is extremely long. Long messages increase download times for those with slow connections. Are you sure you want to risk the wrath of other users by posting a message this long?"))return!1}else if(i.val().length>4e3&&!confirm("This message is very long. Long messages increase download times for those with slow connections. Are you sure you want to post a message this long?"))return!1;return t.LocalLinksWarning&&i.val().match(/<a href=("|')?http:\/\/localhost/gi)&&!confirm("You have included a link to your local machine, not a remote machine. Is this intended?")?!1:i.val().length==0?(alert("Please enter a message"),i.focus(),!1):!0},wt=function(){if(!r&&!ft&&i.length!=0)return i.val()!=et?"You will lose any unsaved text. Is this OK?":void 0},f=function(n){return $("#"+t.PasteSettingElmId+" input[value="+n+"]").parent().parent()},bt=function(n,r,e){if(e){o="html";r?o="code":r=v(e);h=e;c=r;n?f("code").hide():f("code").show();e==v(e)?(t.InitialPasteMode=="text"?(f("html").hide(),f("encoded").hide(),(o=="html"||o=="encoded")&&(o="text")):f("text").hide(),t.InitialPasteMode=="encoded"?(f("html").hide(),f("text").hide(),(o=="html"||o=="text")&&(o="encoded")):f("encoded").hide()):(f("text").show(),f("encoded").show(),f("html").show());b.previewPaste(b.getPasteSetting(),!1);u=i.val();var s=$("#"+t.PasteDialogId);t.PastePreviewOverEditor?s.css("left",(i.width()-s.width()).toString()+"px"):s.css("left",i.width().toString()+"px");t.ShowPastePreviewWindow?$("#"+t.PasteDialogId+" .expando").show():$("#"+t.PasteDialogId+" .expando").hide();$("#"+t.PasteDialogId).fadeIn("fast");y=!0}},kt=function(){u=i.val();var n=i.getSelectionBounds();s=n.start;l=n.end;p=!0;setTimeout(st,300)},st=function(n){var f,o,r,e;if(a||!y||p||i.val()==u||($("#"+t.PasteDialogId).fadeOut("fast"),y=!1),a||!p)return n||(n=window.event),n&&(n.returnValue=!0),!0;if(s<0||l<0||l<s)return!0;if(f=i.val(),k=u,o=f.length-1-(u.length-1-l),r=f.substring(s,o),rt(r))r=v(r),i.val(u),i.selectText(s,l),b.inLinkErAte(r,!0);else{d=g=nt=tt=it=null;var h=i.isCursorInsideTag("pre",r.length),w=i.isCursorInsideOpenTag(r.length),c="";c="<pre>"+r+"<\/pre>";ut()||w||h&&r==v(r)?(e=ot(r),i.val(u.substring(0,s)+e+u.substring(l,u.length)),i.setCaretPosition(s+e.length)):bt(h,c,r)}return u=i.val(),p?(p=!1,!1):void 0};jQuery.fn.getSelectionBounds=function(){var r,f,n,e,o;if(this.length==0)return null;var t=this[0],i=0,u=0;return typeof t.selectionStart!="number"&&document.selection?(r=document.selection.createRange(),r&&r.htmlText?(n=t.createTextRange(),n&&(f=n.duplicate()),n&&f&&(f.moveToBookmark(r.getBookmark()),n.setEndPoint("EndToStart",f),e=r.text.replace(/[\r\n]/g,"."),o=t.value.replace(/[\r\n]/g,"."),i=o.indexOf(e,n.text.length),u=i+e.length)):i=u=this.getCaretPosition()):(i=t.selectionStart,u=t.selectionEnd),{start:i,end:u}};jQuery.fn.getCaretPosition=function(){var n,t,i;if(this.length==0)return null;n=this[0];try{if(t=0,typeof n.selectionStart!="number"&&document.selection){if(n.focus(),i=document.selection.createRange(),!i)return 0;i.moveStart("character",-n.value.length);t=i.text.length}else typeof n.selectionStart!="undefined"&&(t=n.selectionStart);return t}catch(r){return 0}};jQuery.fn.setCaretPosition=function(n){var i,t;if(this.length==0)return this;i=this[0];try{if(i.setSelectionRange)i.focus(),i.setSelectionRange(n,n);else if(i.createTextRange)t=i.createTextRange(),t.move("character",n),t.select();else if(window.getSelection){for(var f=window.getSelection(),t=document.createRange(),e=document.createTreeWalker(i,NodeFilter.SHOW_ELEMENT,null,!1),u=n,r=i;e.nextNode();)if(r=e.currentNode,u>r.value.length)u-=r.value.length;else break;r=r.firstChild;t.setStart(r,u);t.setEnd(r,u);f.removeAllRanges();f.addRange(t)}else document.selection&&(t=document.body.createTextRange(),t.moveToElementText(i),t.setEndPoint("EndToEnd",t),t.moveStart("character",n),t.moveEnd("character",n-i.innerText.length),t.select())}catch(o){}return this};jQuery.fn.getSelectedText=function(){if(this.length==0)return null;var t=this[0],n=this.getSelectionBounds();return n?t.value.substring(n.start,n.end):""};jQuery.fn.replaceSelectedText=function(n,t,i){var u,r,f;if(this.length==0)return this;if(u=this[0],a=!0,r=this.getSelectionBounds(),r){if(f=u.value,t){while(f.substr(r.start,1)==" "&&r.start<f.length)r.start++;while(r.end>0&&f.substr(r.end-1,1)==" ")r.end--;this.selectText(r.start,r.end)}this.val(u.value.substring(0,r.start)+n+u.value.substring(r.end,u.value.length));i&&i>0?this.setCaretPosition(r.start+i):this.setCaretPosition(r.start)}return a=!1,this};jQuery.fn.insertText=function(n){var t,f,e,u;return r||!n||this.length==0?!1:(t=this[0],a=!0,this[0].scrollTop&&(f=this[0].scrollTop),i.focus(),u=this.getSelectionBounds(),u&&u.start>=0?(e=u.start+n.length,this.val(t.value.substring(0,u.start)+n+t.value.substring(u.start,t.value.length))):(i.val(t.value+n),e=t.value.length),this.setCaretPosition(e),f&&(this[0].scrollTop=f),a=!1,!1)};ht=function(){e&&e.select&&e.select();e=null};jQuery.fn.selectText=function(n,t){if(this.length==0)return this;var i=this[0];return typeof i.selectionStart!="number"&&document.selection&&document.selection.createRange?(e=i.createTextRange(),e.move("character",n),e.moveStart("character",0),e.moveEnd("character",t-n+1),e=e.duplicate(),setTimeout(ht,0)):(i.selectionStart=n,i.selectionEnd=t),this};jQuery.fn.expandSelectionToLines=function(){if(this.length==0)return this;for(var n=this.getSelectionBounds();n.start>0&&this.val().substring(n.start-1,n.start)!="\n";)n.start--;for(this.val().substring(n.start,n.start+1)=="\n"&&n.start<this.val().length&&n.start++;n.end<this.val().length&&this.val().substring(n.end,n.end+1)!="\n";)n.end++;return this.selectText(n.start,n.end),this};jQuery.fn.isCursorInsideTag=function(n,t){var r,i;if(this.length==0)return null;if(r=!1,i=this.getCaretPosition(),t&&i&&(i-=t),i&&i>0){var u=this[0].value.substr(0,i),o=new RegExp("<"+n+"(s)*","gi"),s=new RegExp("<\/"+n+">","gi"),f=u.match(o),e=u.match(s);f&&(e?f.length>e.length&&(r=!0):r=!0)}return r};jQuery.fn.isCursorInsideOpenTag=function(n){var i,t;if(this.length==0)return null;if(i=!1,t=this.getCaretPosition(),n&&t&&(t-=n),t&&t>0){var u=this[0].value.substr(0,t),f=new RegExp("<[a-z]+\\s+[^>]*$","mi"),r=u.match(f);i=r!=null&&r.length>0}return i};String.prototype.htmlEncode=function(){var n=document.createElement("div"),t=document.createTextNode(this);return n.appendChild(t),n.innerHTML};String.prototype.toTitleCase=function(n,t){if(this==null||this.length<0)return"";n=n?n:["a","an","the","and","but","or","for","nor","as","at","by","for","from","in","into","near","of","on","onto","to","with"];t=t?t:["I","ASP.NET",".NET","C#","C++","VB","VB.NET","SQL","F#"];for(var r=this.split(" "),u="",i=0;i<r.length;i++)u.length>0&&(u+=" "),u+=n.indexOf(r[i].toLowerCase())<0?t.indexOf(r[i].toUpperCase())<0?r[i].length>1?r[i].substring(0,1).ToUpper()+r[i].substring(1).ToUpper():r[i]:r[i].toUpperCase():r[i].toLowerCase();return u};String.prototype.toSentenceCase=function(n,t){if(this==null||this.length<0)return"";n=n?n:["a","an","the","and","but","or","for","nor","as","at","by","for","from","in","into","near","of","on","onto","to","with"];t=t?t:["I","ASP.NET",".NET","C#","C++","VB","VB.NET","SQL","F#"];for(var r=this.split(" "),u="",i=0;i<r.length;i++)u.length>0&&(u+=" "),u+=n.indexOf(r[i].toLowerCase())<0?t.indexOf(r[i].toUpperCase())<0?r[i]:r[i].toUpperCase():r[i].toLowerCase();return u.substring(0,1).toUpperCase()+u.substring(1)};this.toggleWrapSelection=function(n,t){if(r||n.length<=0)return!1;t||(t="");var f="<"+n+(t.length>0?" "+t:t)+">",e="<\/"+n+">",u=i.getSelectedText();return u.substr(0,f.length)==f&&u.substr(u.length-e.length)==e?(u=u.substr(f.length,u.length-f.length-e.length),i.replaceSelectedText(u)):(u=f+$.trim(u)+e,i.replaceSelectedText(u,!0,f.length)),!1};this.insertText=function(n){return i.insertText(n),!1};this.getPasteSetting=function(){var i=$("#"+t.PasteSettingElmId+" input[type=radio]"),n;if(!i)return"auto";for(n=0;n<i.length;n++)if(i[n].checked)return i[n].value};this.getSanitisedMesssageHtml=function(n,i,r,u,f,e,o){var s=null,h={JSON:!0,Content:n,Signature:i,WysiwygEditorUsed:r,IgnoreHtml:u,AllowMarkdown:f};return $.ajax({type:"POST",async:e,cache:!1,dataType:"json",data:h,timeout:500,url:t.SanitiseHtmlUrl,success:function(n){s=n&&n.html&&n.html!=""?decodeURIComponent(n.html):"An unexpected error occurred.";o&&o(s)},error:function(n,t,i){i}}),s};this.previewPaste=function(n,r){var a="#"+t.PasteDialogId+" .paste-preview",f,e,y;if(!h||!h.trim()){$(a).html("");return}f="";e=null;n=="auto"&&(n=o);n=="text"?(f=lt(h),e=d):n=="encoded"?(f=v(h),e=g):n=="html"?(f=h,e=nt):n=="quote"?(f='<blockquote class="quote"><div class="op">Quote:<\/div>'+h+"<\/blockquote>",e=tt):n=="code"&&(w()&&w()<=9&&(c=ot(c)),c.indexOf("<pre")<0&&(c="<pre>"+c+"<\/pre>"),f=c,e=it);t.ShowPastePreviewWindow&&(e==null?this.getSanitisedMesssageHtml(f,"",n=="html",n=="encoded",!1,!0,function(t){$(a).html(t);n=="text"?d=t:n=="encoded"?g=t:n=="html"?nt=t:n=="quote"?tt=t:n=="code"&&(it=t)}):$(a).html(e));r||(y=k.substring(0,s)+f+k.substring(l),i.val(y),u=y,i.setCaretPosition(s+f.length))};this.inLinkErAte=function(n,t){var f,u,e;return r?!1:(f=i.getSelectedText(),n||(n=f),rt(n)||(n=null),i.focus(),n?(u=vt(f,n,t),u.html.length>0&&(e=i.getSelectionBounds(),i.replaceSelectedText(u.html,!0),i.selectText(e.start+u.offset,e.start+u.offset+u.titleLength))):t?i.insertText('<a href=""><\/a>[<a href="" target="_blank">^<\/a>]'):i.insertText('<a href=""><\/a>'),!1)};this.encoderate=function(){if(r)return!1;var n=i.getSelectedText(),t=v(n);if(n!=t)return i.replaceSelectedText(t),!1};this.fixCase=function(){if(r)return!1;var n=i.getSelectedText(),t=yt(n,"Sentence");if(n!=t)return i.replaceSelectedText(t),!1};this.untab=function(){var u,f;if(r)return!1;for(var t="",o=i.getSelectedText(),e=4,s,n=e,u=0;u<o.length;u++)if(f=o.substring(u,u+1),f=="\t"){for(s=0;s<n;s++)t+=" ";n=e}else f=="\n"?(t+=f,n=e):(t+=f,n--,n<=0&&(n=e));if(o!=t)return i.replaceSelectedText(t),!1};this.adjustLeading=function(n){var e,u,t,f;return r?!1:(e=i.expandSelectionToLines().getSelectionBounds(),u=i.getSelectedText(),n<0?(f=new RegExp("^(\t| {1,4})","gim"),t=u.replace(f,"")):(f=w()&&w()<=9?new RegExp("^[^\n]?","gim"):new RegExp("^","gim"),t=u.replace(f,"    ")),u==t)?void 0:(i.replaceSelectedText(t),i.selectText(e.start,e.start+t.length),!1)};this.quoteText=function(n){var e=!ut(),u,f,r;if(t.QuoteableElmId!=""){if(u=document.getElementById(t.QuoteableElmId),document.all)if(document.selection&&document.selection.createRange){for(elm=document.selection.createRange().parentElement();elm&&elm!=u&&elm.parentElement;)elm=elm.parentElement;if(elm!=u)return!1}else return;else if(window.getSelection){for(elm=window.getSelection().anchorNode;elm&&elm!=u;)elm=elm.parentNode;if(!elm)return!1}else return!1;return f=at(),f&&f!=""?(r="",i.val()!=""&&(r+="\n"),e&&(r+='<blockquote class="quote"><div class="op">'),r+=n+" wrote:",r+=e?"<\/div>":"\n",r+=f,r+=e?"<\/blockquote>":"\n",r+="\n",i.insertText(r)):alert("You did not select any text to quote"),!1}};this.cancelMsg=function(){return i.val()&&!confirm("Are you sure you want to cancel this post?")?!1:(ft=!0,history.back(-1),!1)};this.onEditorSubmit=function(){return t.EnsureContentValidation&&!pt()?!1:t.OnSubmit&&!t.OnSubmit()?!1:(r=!0,!0)};this.signalPostingInProgress=function(){r=!0};this.signalPostingEnded=function(){r=!1};this.isPostingInProgress=function(){return r};this.initialise=function(){var n=window.onbeforeunload;window.onbeforeunload=function(){var t=wt();return n&&n(),t};i.length<=0?i=null:et=i.val();i.bind("keyup",st);i.bind("paste",kt);i.bind("click",function(){return $("#"+t.PasteDialogId).stop(!0,!0).fadeOut("fast"),y=!1,!1});$("#"+t.PasteDialogId+" a.close-notify").click(function(){return $("#"+t.PasteDialogId).stop(!0,!0).fadeOut("fast"),y=!1,!1})}}var defaultEditorConfig={InitialPasteMode:"text",ShowPastePreviewWindow:!1,PastePreviewOverEditor:!1,LongMsgWarning:!0,LocalLinksWarning:!0,EnsureContentValidation:!0,PasteDialogId:"",IgnoreHtmlId:"",AllowMarkdownId:"",QuoteableElmId:"",PasteSettingElmId:"",OnSubmit:null,SniffCodeUrl:null,SniffCodeParameter:null,SanitiseHtmlUrl:null,GetTitlePaths:[]};